---
phase: 04-auto-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/sync-tokens.ts
  - app/src/lib/data.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running npm run sync:tokens with valid credentials fetches real Anthropic usage data into tokens.json"
    - "Running npm run sync:tokens without credentials warns and preserves existing data"
    - "Token entries written match the TokenEntry interface shape"
  artifacts:
    - path: "scripts/sync-tokens.ts"
      provides: "Anthropic usage API sync script"
      min_lines: 60
    - path: "app/src/lib/data.ts"
      provides: "writeTokenData helper"
      contains: "writeTokenData"
  key_links:
    - from: "scripts/sync-tokens.ts"
      to: "data/tokens.json"
      via: "writeTokenData or direct fs.writeFileSync"
      pattern: "tokens\\.json"
    - from: "scripts/sync-tokens.ts"
      to: "https://api.anthropic.com"
      via: "fetch call to usage endpoint"
      pattern: "api\\.anthropic\\.com"
---

<objective>
Create a sync script that fetches real token usage data from the Anthropic Admin API and writes it to data/tokens.json.

Purpose: Delivers TOKN-04 — real token usage on the dashboard instead of manual entries.
Output: scripts/sync-tokens.ts + writeTokenData helper + npm script
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@app/src/lib/data.ts
@scripts/sync-projects.ts
@data/tokens.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add writeTokenData helper to data.ts</name>
  <files>app/src/lib/data.ts</files>
  <action>
    Add a `writeTokenData(data: TokenData): void` function to data.ts, following the same pattern as `writeProjects`:
    - Build path: `path.join(dataDir, "tokens.json")`
    - Write with `JSON.stringify(data, null, 2) + "\n"`
    - Export the function

    This is a 3-line function. Do NOT modify any existing functions.
  </action>
  <verify>TypeScript compiles: `cd app && npx tsc --noEmit`</verify>
  <done>writeTokenData exported from data.ts, mirrors writeProjects pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create sync-tokens.ts script and npm script</name>
  <files>scripts/sync-tokens.ts, package.json</files>
  <action>
    Create `scripts/sync-tokens.ts` following the same style as `scripts/sync-projects.ts` (uses node:fs, node:path, resolve(__dirname, "..")).

    Script logic:

    1. Read env vars: `ANTHROPIC_ADMIN_KEY` and `ANTHROPIC_ORG_ID`
       - If either is missing, print: "ANTHROPIC_ADMIN_KEY and ANTHROPIC_ORG_ID required. Skipping token sync." and exit 0 (not an error).

    2. Read existing tokens.json from `join(ROOT, "data", "tokens.json")` to preserve budget config.

    3. Fetch from Anthropic Admin API:
       ```
       GET https://api.anthropic.com/v1/organizations/{org_id}/usage
       Headers:
         x-api-key: {admin_key}
         anthropic-version: 2023-06-01
         Content-Type: application/json
       ```
       - Use native `fetch` (Node 18+).
       - If fetch fails (network error, 401, 403, etc.), print warning with status code and exit 0, preserving existing data.

    4. Map API response to TokenEntry[] format:
       - The Anthropic usage API returns daily usage data. Map each entry to: `{ date, project: "api-usage", session: "auto-sync", tokensIn: input_tokens, tokensOut: output_tokens, cost, model }`.
       - If the response structure doesn't match expectations, log a warning and exit 0.

    5. Merge strategy:
       - Keep ALL existing manual entries (entries where session !== "auto-sync").
       - Replace only entries where session === "auto-sync" with fresh API data.
       - This lets users keep manually-added entries alongside real API data.

    6. Write merged data back to tokens.json using `writeFileSync` directly (script runs outside Next.js context, so import from data.ts won't work cleanly — just use fs directly like sync-projects.ts does).

    7. Print summary: "Synced {N} entries from Anthropic API. Total entries: {M}."

    In root `package.json`, add to scripts:
    ```
    "sync:tokens": "npx tsx scripts/sync-tokens.ts"
    ```
  </action>
  <verify>
    1. `npx tsx scripts/sync-tokens.ts` without env vars prints skip message and exits 0
    2. `cat data/tokens.json` still has all existing entries after running without credentials
  </verify>
  <done>
    - Script runs without errors when no credentials set (graceful skip)
    - Script is wired to `npm run sync:tokens`
    - Existing manual token data is preserved
  </done>
</task>

</tasks>

<verification>
1. `npm run sync:tokens` runs without error (no credentials = graceful skip)
2. `cat data/tokens.json | python3 -m json.tool` still valid JSON with all 18 existing entries
3. `grep writeTokenData app/src/lib/data.ts` finds the new export
4. `cd app && npx tsc --noEmit` passes
</verification>

<success_criteria>
- TOKN-04 delivered: sync script exists, fetches from Anthropic API when credentials available
- Graceful degradation: no credentials = warning + skip, no data loss
- npm run sync:tokens wired and working
</success_criteria>

<output>
After completion, create `.planning/phases/04-auto-sync/04-01-SUMMARY.md`
</output>
