---
phase: 04-auto-sync
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/sync-quality.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running npm run sync:quality scans project dirs and writes found metrics to quality.json"
    - "Projects without coverage or lighthouse reports get sensible defaults or are skipped"
    - "Quality entries written match the QualityEntry interface shape"
  artifacts:
    - path: "scripts/sync-quality.ts"
      provides: "Quality metrics collection script"
      min_lines: 80
  key_links:
    - from: "scripts/sync-quality.ts"
      to: "data/quality.json"
      via: "fs.writeFileSync"
      pattern: "quality\\.json"
    - from: "scripts/sync-quality.ts"
      to: "projects/*"
      via: "readdirSync scanning for coverage reports"
      pattern: "coverage|lighthouse"
---

<objective>
Create a sync script that scans project directories for test coverage and Lighthouse reports, then writes collected metrics to data/quality.json.

Purpose: Delivers QUAL-03 â€” auto-collected quality metrics instead of manual data entry.
Output: scripts/sync-quality.ts + npm script
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@app/src/lib/data.ts
@scripts/sync-projects.ts
@data/quality.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sync-quality.ts script</name>
  <files>scripts/sync-quality.ts</files>
  <action>
    Create `scripts/sync-quality.ts` following sync-projects.ts style (node:fs, node:path, resolve(__dirname, "..")).

    Script logic:

    1. Scan each directory in `projects/` (same pattern as sync-projects.ts).

    2. For each project, look for coverage reports in these locations (check in order, use first found):
       - `coverage/coverage-summary.json` (Jest/Vitest Istanbul output)
       - `coverage/coverage-final.json` (Istanbul)
       - `.nyc_output/*.json` (nyc/Istanbul)

       If `coverage-summary.json` found, parse it:
       ```json
       { "total": { "lines": { "pct": 85.5 }, "statements": { "pct": 84.2 } } }
       ```
       Use `total.lines.pct` as both frontend and backend coverage (we can't distinguish without more info). Round to integer.

       If no coverage report found, set testCoverage to `{ frontend: 0, backend: 0 }`.

    3. For Lighthouse, look for:
       - `lighthouse-report.json` or `.lighthouseci/*.json` in project root
       - Parse: look for `categories.performance.score` (0-1 scale, multiply by 100)

       If no Lighthouse report found, set lighthouseScore to 0.

    4. For open issues, try:
       - Count files matching `TODO` or `FIXME` in source files using a simple grep-like scan of `*.ts`, `*.tsx`, `*.js` files (limit to top 3 dirs deep to avoid node_modules). Cap at scanning 200 files per project for performance.
       - If scan fails or takes too long, default to 0.

    5. For techDebt, derive from coverage + lighthouse:
       - Both > 80: "low"
       - Both > 50: "medium"
       - Either is 0 (no data): "none"
       - Otherwise: "high"

    6. Read existing quality.json. Merge strategy:
       - For each project scanned, replace its entry (match by project id).
       - Keep entries for projects NOT in the projects/ directory (could be external).
       - Set date to today's ISO date (YYYY-MM-DD).

    7. Write merged array to data/quality.json with `JSON.stringify(data, null, 2) + "\n"`.

    8. Print summary: "Scanned {N} projects. Found coverage in {X}, lighthouse in {Y}. Updated quality.json."
  </action>
  <verify>
    1. `npx tsx scripts/sync-quality.ts` runs without error
    2. `cat data/quality.json | python3 -m json.tool` is valid JSON
    3. Output includes scan summary line
  </verify>
  <done>
    - Script scans all project dirs for coverage and lighthouse reports
    - quality.json updated with real data where available, sensible defaults otherwise
    - Each entry matches QualityEntry shape (project, date, testCoverage, lighthouseScore, openIssues, techDebt)
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire npm script and validate end-to-end</name>
  <files>package.json</files>
  <action>
    Add to root package.json scripts:
    ```
    "sync:quality": "npx tsx scripts/sync-quality.ts"
    ```

    Also add a combined sync-all script:
    ```
    "sync:all": "npx tsx scripts/sync-projects.ts && npx tsx scripts/sync-tokens.ts && npx tsx scripts/sync-quality.ts"
    ```

    Note: package.json may already have `sync:tokens` from plan 04-01. If so, just add `sync:quality` and `sync:all`. If 04-01 hasn't run yet, add all three new scripts. Read package.json first to check current state.
  </action>
  <verify>
    1. `npm run sync:quality` runs without error
    2. `npm run sync:all` runs all three sync scripts in sequence
  </verify>
  <done>
    - npm run sync:quality wired
    - npm run sync:all runs all sync scripts
  </done>
</task>

</tasks>

<verification>
1. `npm run sync:quality` completes without error
2. `cat data/quality.json | python3 -m json.tool` is valid JSON array
3. Each entry has: project, date, testCoverage.frontend, testCoverage.backend, lighthouseScore, openIssues, techDebt
4. `npm run sync:all` runs all sync scripts sequentially
</verification>

<success_criteria>
- QUAL-03 delivered: quality metrics auto-collected from project directories
- Script handles missing reports gracefully (defaults to 0 / "none")
- npm run sync:quality and sync:all wired and working
</success_criteria>

<output>
After completion, create `.planning/phases/04-auto-sync/04-02-SUMMARY.md`
</output>
