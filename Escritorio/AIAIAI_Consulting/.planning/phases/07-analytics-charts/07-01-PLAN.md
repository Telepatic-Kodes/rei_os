---
phase: 07-analytics-charts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/package.json
  - app/src/lib/data.ts
  - app/src/components/sidebar.tsx
  - app/src/components/analytics/spend-trend-chart.tsx
  - app/src/app/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "Analytics page is accessible via sidebar navigation at /analytics"
    - "A line chart shows daily token spend over the past 7 days by default"
    - "User can toggle between 7-day and 30-day time windows"
    - "Summary stat cards show total spend, burn rate, total tokens, and model count"
  artifacts:
    - path: "app/src/components/analytics/spend-trend-chart.tsx"
      provides: "Line chart with 7d/30d toggle"
      contains: "use client"
    - path: "app/src/app/analytics/page.tsx"
      provides: "Analytics dashboard page layout"
      contains: "SpendTrendChart"
    - path: "app/src/lib/data.ts"
      provides: "getAnalytics() and getDailySpendByModel() helpers"
      contains: "getDailySpendByModel"
  key_links:
    - from: "app/src/app/analytics/page.tsx"
      to: "app/src/lib/data.ts"
      via: "getAnalytics() and getDailySpendByModel() calls"
      pattern: "getAnalytics|getDailySpendByModel"
    - from: "app/src/components/analytics/spend-trend-chart.tsx"
      to: "recharts"
      via: "LineChart, ResponsiveContainer imports"
      pattern: "from.*recharts"
---

<objective>
Install Recharts, create data helper functions for chart data, and build the spend trend line chart on a new analytics page with summary stat cards.

Purpose: Delivers the core charting infrastructure (ANLT-02) — users can see token spend trends over 7 and 30 days on a dedicated analytics page.
Output: Working analytics page at /analytics with a multi-line spend trend chart and summary stats.
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-analytics-charts/07-RESEARCH.md

@app/src/lib/data.ts
@app/src/lib/schemas.ts
@app/src/components/stat-card.tsx
@app/src/components/sidebar.tsx
@data/tokens.json
@data/analytics.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts and create data helpers</name>
  <files>
    app/package.json
    app/src/lib/data.ts
    app/src/components/sidebar.tsx
  </files>
  <action>
    1. Install recharts in the app directory:
       ```bash
       cd /home/tomas/Escritorio/AIAIAI_Consulting/app && npm install recharts
       ```
       Recharts 3.7.0 supports React 19 — no overrides needed.

    2. Add `getAnalytics()` function to `app/src/lib/data.ts`:
       - Import `AnalyticsSchema` from `./schemas`
       - Import `Analytics` type from `./schemas`
       - Re-export `Analytics` type
       - Read and validate `analytics.json` using `readValidatedJson("analytics.json", AnalyticsSchema)`

    3. Add `getDailySpendByModel()` function to `app/src/lib/data.ts`:
       - Signature: `getDailySpendByModel(days: 7 | 30 | 90): Array<Record<string, string | number>>`
       - Read tokens.json via `getTokenData()`
       - Calculate cutoff date (today minus `days`)
       - Filter entries where `entry.date >= cutoff` (string comparison works for ISO dates)
       - Group by date, summing cost per model name (use short model names: strip "claude-" prefix)
       - Return sorted array of `{ date, opus45, sonnet45, ... }` objects (one per day)
       - Shorten model keys: `"claude-opus-4-5"` -> `"opus45"`, `"claude-sonnet-4-5"` -> `"sonnet45"` etc. Use a helper that replaces `claude-` prefix and removes hyphens between version numbers.

    4. Add analytics nav item to sidebar.tsx:
       - Add `{ href: "/analytics", label: "Analytics", icon: "^" }` after the Tokens entry in the navItems array.
  </action>
  <verify>
    - `cd /home/tomas/Escritorio/AIAIAI_Consulting/app && npm ls recharts` shows recharts installed
    - `npx tsc --noEmit` compiles without errors
  </verify>
  <done>
    recharts installed, getAnalytics() and getDailySpendByModel() are exported from data.ts, sidebar includes /analytics link
  </done>
</task>

<task type="auto">
  <name>Task 2: Build spend trend chart and analytics page</name>
  <files>
    app/src/components/analytics/spend-trend-chart.tsx
    app/src/app/analytics/page.tsx
  </files>
  <action>
    1. Create `app/src/components/analytics/spend-trend-chart.tsx` as a Client Component:
       - `"use client"` directive at top
       - Import: `{ LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer }` from `"recharts"`
       - Import Card/CardContent/CardHeader/CardTitle from `@/components/ui/card`
       - Props interface: `{ data: Array<Record<string, string | number>>; modelKeys: string[] }`
       - State: `window` ("7d" | "30d") with default "7d" — but NOTE: the parent page passes different data based on the window, so use a callback prop `onWindowChange?: (w: "7d" | "30d") => void` OR keep it simple: accept `data` and `modelKeys` as props, let parent handle window switching. Use the simpler approach: parent passes data, chart just renders.
       - Actually, since this is Server Component -> Client Component, make the chart accept ALL data (both windows) and handle toggle internally:
         - Props: `{ data7d: Array<Record<string, string | number>>; data30d: Array<Record<string, string | number>>; modelKeys: string[] }`
         - Internal state for active window, switches between data7d and data30d
       - Render toggle buttons (7D / 30D) in CardHeader, styled as small pill buttons with Tailwind
       - ResponsiveContainer width="100%" height={300}
       - LineChart with CartesianGrid (strokeDasharray="3 3", stroke="hsl(var(--border))")
       - XAxis: dataKey="date", tickFormatter showing MM-DD (val.slice(5)), fontSize 11, fill="hsl(var(--muted-foreground))"
       - YAxis: tickFormatter prepending "$", fontSize 11
       - Tooltip with themed background: backgroundColor="hsl(var(--popover))", border="1px solid hsl(var(--border))", formatter showing $value.toFixed(2)
       - Legend component
       - One Line per model key: type="monotone", strokeWidth=2, dot={{ r: 3 }}
       - Colors: use CSS variables hsl(var(--chart-1)) for first model, hsl(var(--chart-2)) for second, etc.
       - Wrap with React.memo for performance

    2. Create `app/src/app/analytics/page.tsx` as a Server Component:
       - Import `getAnalytics`, `getDailySpendByModel`, `getTokenData` from `@/lib/data`
       - Import `SpendTrendChart` from `@/components/analytics/spend-trend-chart`
       - Import `StatCard` from `@/components/stat-card`
       - Call getAnalytics() for summary stats
       - Call getDailySpendByModel(7) and getDailySpendByModel(30) for chart data
       - Extract modelKeys from the first data point (Object.keys minus "date")
       - Render page layout:
         - `<h1 className="text-3xl font-bold">Analytics</h1>`
         - Summary stats grid (grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4):
           - "30-Day Spend": `$${window30d.totalCost.toFixed(2)}`
           - "Daily Burn Rate": `$${window30d.burnRate.toFixed(2)}/day`
           - "Tokens (30d)": format as M (millions) with 1 decimal
           - "Active Models": count of keys in window30d.byModel
         - SpendTrendChart with data7d, data30d, modelKeys
         - Placeholder div for "Cost by Model" and "Burn Rate" (to be filled by Plan 07-02)
       - Use `space-y-8` for vertical spacing
  </action>
  <verify>
    - `cd /home/tomas/Escritorio/AIAIAI_Consulting/app && npx tsc --noEmit` compiles without errors
    - `npm run build` completes successfully
    - Navigate to http://localhost:3000/analytics — page renders with stat cards and line chart
  </verify>
  <done>
    Analytics page renders at /analytics with 4 stat cards and a spend trend line chart with 7D/30D toggle showing per-model daily spend
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes in app directory
2. /analytics page loads without errors
3. Line chart renders with actual data from tokens.json
4. 7D/30D toggle switches chart data
5. Sidebar shows Analytics link
</verification>

<success_criteria>
- Recharts installed and working with React 19
- Analytics page accessible at /analytics with sidebar navigation
- Spend trend line chart shows daily cost per model with 7d/30d toggle
- Summary stat cards display pre-computed analytics values
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-analytics-charts/07-01-SUMMARY.md`
</output>
