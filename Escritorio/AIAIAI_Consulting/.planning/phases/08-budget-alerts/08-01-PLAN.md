---
phase: 08-budget-alerts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/lib/schemas.ts
  - app/src/lib/alert-config.ts
  - app/src/lib/alert-evaluator.ts
  - data/config/alerts.json
  - data/alert-state.json
  - app/src/components/ui/alert.tsx
  - app/src/components/alert-banner.tsx
  - app/src/app/layout.tsx
  - app/src/app/api/alert-status/route.ts
  - app/src/app/api/settings/alerts/route.ts
  - app/src/app/settings/page.tsx
  - app/src/components/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "When global spend crosses 75% or 90% of configurable budget, an alert banner appears at the top of the dashboard"
    - "Each project can have its own budget limit in alerts.json, and crossing it triggers a banner"
    - "Alert thresholds and per-project limits are editable via /settings page and saved to JSON"
    - "Alerts fire once per threshold per month, resetting on calendar month boundary"
    - "Banners are dismissible per-session (localStorage)"
  artifacts:
    - path: "app/src/lib/alert-evaluator.ts"
      provides: "Threshold evaluation logic with fire-once tracking"
      exports: ["evaluateAlerts"]
    - path: "app/src/lib/alert-config.ts"
      provides: "Config loading with defaults and validation"
      exports: ["loadAlertConfig", "DEFAULT_ALERT_CONFIG"]
    - path: "data/config/alerts.json"
      provides: "User-editable alert configuration"
      contains: "globalBudget"
    - path: "app/src/components/alert-banner.tsx"
      provides: "Dismissible alert banners at top of dashboard"
    - path: "app/src/app/settings/page.tsx"
      provides: "Settings UI for editing thresholds and per-project limits"
    - path: "app/src/app/api/settings/alerts/route.ts"
      provides: "GET/POST endpoints for alert config CRUD"
      exports: ["GET", "POST"]
    - path: "app/src/app/api/alert-status/route.ts"
      provides: "Active alerts endpoint for client polling"
      exports: ["GET"]
  key_links:
    - from: "app/src/components/alert-banner.tsx"
      to: "/api/alert-status"
      via: "fetch in useEffect"
      pattern: "fetch.*api/alert-status"
    - from: "app/src/app/api/alert-status/route.ts"
      to: "app/src/lib/alert-evaluator.ts"
      via: "evaluateAlerts() call"
      pattern: "evaluateAlerts"
    - from: "app/src/app/settings/page.tsx"
      to: "/api/settings/alerts"
      via: "fetch POST on save"
      pattern: "fetch.*api/settings/alerts"
---

<objective>
Create the alert configuration system, threshold evaluation engine, dashboard alert banners, and settings UI page.

Purpose: Users get visual warnings in the dashboard when budget thresholds are crossed, and can configure thresholds and per-project limits via a settings page without editing JSON files directly.

Output: Alert config file (alerts.json), alert evaluator, alert state tracker, alert banner component, settings page with form, API endpoints for config CRUD and alert status.
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/src/lib/schemas.ts
@app/src/lib/atomic-write.ts
@app/src/lib/analytics.ts
@app/src/app/layout.tsx
@app/src/components/sidebar.tsx
@data/config/budget.json
@data/analytics.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Alert schemas, config loader, evaluator, and alert state</name>
  <files>
    app/src/lib/schemas.ts
    app/src/lib/alert-config.ts
    app/src/lib/alert-evaluator.ts
    data/config/alerts.json
  </files>
  <action>
1. Extend schemas.ts with these new Zod schemas:
   - AlertThresholdSchema: { percent: number (0-100), label: string optional }
   - AlertConfigSchema: { globalBudget: number min(1), globalThresholds: array of AlertThresholdSchema, perProjectLimits: record(string, number min(0)) keyed by project NAME }
   - AlertStateSchema: { firedAlerts: string[], lastReset: string (ISO), month: string (YYYY-MM) }
   - AlertResultSchema: { type: "global" | "project", level: "warning" | "critical", message: string, alertKey: string, projectName: string optional }
   - Export inferred types for all.

2. Create alert-config.ts:
   - DEFAULT_ALERT_CONFIG with globalBudget: 200, globalThresholds: [{percent: 75, label: "Warning"}, {percent: 90, label: "Critical"}], perProjectLimits: {}
   - loadAlertConfig() reads data/config/alerts.json, validates with Zod, returns defaults on missing/invalid. Uses path.join(process.cwd(), "data", "config", "alerts.json").
   - saveAlertConfig(config) validates then uses atomicWriteJson to write.

3. Create alert-evaluator.ts:
   - evaluateAlerts(): Promise<AlertResult[]>
   - Reads analytics.json for global spend (use 30d window totalCost as monthly spend).
   - Reads tokens.json and aggregates cost per project name for per-project evaluation.
   - Reads alert-state.json (create if missing with empty firedAlerts, current month).
   - Monthly reset: compare alert-state month (YYYY-MM) with current month. If different, clear firedAlerts and update month.
   - For each global threshold: calculate percentSpent = (totalCost / globalBudget) * 100. If >= threshold.percent AND alertKey "global-{percent}" not in firedAlerts, add to results.
   - For each perProjectLimit: sum cost for that project name from tokens.json entries in current month. If >= limit AND alertKey "project-{name}-limit" not in firedAlerts, add to results.
   - Threshold >= 90% is "critical" level, below is "warning".
   - After evaluation, append new alertKeys to firedAlerts and save alert-state.json via atomicWriteJson.
   - Return AlertResult[] (can be empty if no new alerts).
   - getActiveAlerts(): Promise<AlertResult[]> — similar to evaluateAlerts but does NOT update state, just returns all currently-crossed thresholds (for banner display). This reads config + analytics and checks what's breached, ignoring firedAlerts.

4. Create data/config/alerts.json with the DEFAULT_ALERT_CONFIG values.
  </action>
  <verify>
    - `npx tsx -e "import { AlertConfigSchema } from './app/src/lib/schemas'; console.log(AlertConfigSchema.parse({globalBudget:200,globalThresholds:[{percent:75}],perProjectLimits:{}}))"` succeeds
    - `npx tsx -e "import { loadAlertConfig } from './app/src/lib/alert-config'; console.log(loadAlertConfig())"` returns config with globalBudget 200
    - data/config/alerts.json exists with valid content
  </verify>
  <done>Alert config loads with defaults, evaluator can detect threshold breaches for both global and per-project budgets, alert state tracks fired alerts with monthly reset</done>
</task>

<task type="auto">
  <name>Task 2: Alert banner, API endpoints, settings page, and sidebar link</name>
  <files>
    app/src/components/ui/alert.tsx
    app/src/components/alert-banner.tsx
    app/src/app/api/alert-status/route.ts
    app/src/app/api/settings/alerts/route.ts
    app/src/app/settings/page.tsx
    app/src/app/layout.tsx
    app/src/components/sidebar.tsx
  </files>
  <action>
1. Add shadcn/ui Alert component: run `cd app && npx shadcn@latest add alert --yes`. If that fails, create app/src/components/ui/alert.tsx manually with Alert, AlertTitle, AlertDescription exports using shadcn/ui pattern (cva variants: default and destructive).

2. Create app/src/app/api/alert-status/route.ts:
   - GET handler calls getActiveAlerts() from alert-evaluator.
   - Returns NextResponse.json({ alerts: AlertResult[] }).
   - Wrap in try/catch, return empty alerts on error.

3. Create app/src/app/api/settings/alerts/route.ts:
   - GET handler: loadAlertConfig() and return as JSON.
   - POST handler: parse request body with AlertConfigSchema.parse(), saveAlertConfig(), return { success: true }. On ZodError return 400 with error messages. On other errors return 500.

4. Create app/src/components/alert-banner.tsx:
   - "use client" component.
   - Fetches /api/alert-status on mount (useEffect).
   - Maintains dismissed[] state in useState, initialized from localStorage key "dismissed-alerts" (JSON.parse, fallback []).
   - On dismiss: add alertKey to dismissed, write to localStorage.
   - Filter out dismissed alerts from display.
   - Render each alert as shadcn/ui Alert: variant="destructive" for critical, variant="default" for warning. Include AlertTriangle icon from lucide-react. Include X close button (ghost variant, absolute positioned top-right). AlertTitle shows "Critical Budget Alert" or "Budget Warning". AlertDescription shows alert.message.
   - If no visible alerts, render null.

5. Update app/src/app/layout.tsx:
   - Import AlertBanner from "@/components/alert-banner".
   - Place <AlertBanner /> inside main, BEFORE <DashboardHeader />.

6. Create app/src/app/settings/page.tsx:
   - "use client" page.
   - Fetches GET /api/settings/alerts on mount to populate form.
   - Form fields: globalBudget (number input), globalThresholds (list of percent inputs with add/remove), perProjectLimits (list of name+limit pairs with add/remove).
   - Use existing shadcn/ui components: Card, Input (add via shadcn if needed), Button, Separator.
   - On save: POST to /api/settings/alerts with form data. Show toast via sonner on success/error.
   - Include a "Browser Notifications" section with permission status display and "Enable Browser Notifications" button that calls Notification.requestPermission() on click. Show current permission state. If denied, show message to enable in browser settings.
   - Style with Tailwind: max-w-2xl mx-auto, proper spacing, section headings.

7. Update app/src/components/sidebar.tsx:
   - Add a "Settings" link pointing to /settings with a Settings (gear) icon from lucide-react. Place it at the bottom of the nav, visually separated.
  </action>
  <verify>
    - `cd app && npm run build` completes without errors
    - Visit http://localhost:3000 — alert banner appears if spend > 75% of budget
    - Visit http://localhost:3000/settings — settings form loads with current config
    - Clicking save on settings page shows success toast
    - Dismissing an alert banner hides it, persists on same-session reload
    - Sidebar shows Settings link at bottom
  </verify>
  <done>Dashboard shows alert banners for breached thresholds (both global and per-project), settings page allows editing thresholds and per-project limits, banners are dismissible per-session, sidebar has settings navigation</done>
</task>

</tasks>

<verification>
1. Alert banner appears when global spend exceeds 75% of globalBudget (check with current analytics.json data — 30d totalCost vs 200 budget)
2. Settings page loads at /settings with current config values
3. Editing globalBudget and saving persists to data/config/alerts.json
4. Adding a per-project limit and saving shows it in config
5. Dismissing a banner hides it; refreshing page within same session keeps it hidden
6. API GET /api/alert-status returns active alerts array
7. API GET /api/settings/alerts returns current config
8. API POST /api/settings/alerts validates and saves
9. `npm run build` succeeds in app directory
</verification>

<success_criteria>
- Alert banners visible at top of dashboard for breached global/per-project thresholds
- Settings page functional at /settings with form for all alert configuration
- Config persisted in data/config/alerts.json, readable without code changes
- Alert state tracks fired alerts with monthly reset in data/alert-state.json
- All API endpoints return correct responses
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-budget-alerts/08-01-SUMMARY.md`
</output>
