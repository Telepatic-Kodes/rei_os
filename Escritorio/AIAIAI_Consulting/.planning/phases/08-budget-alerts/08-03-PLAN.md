---
phase: 08-budget-alerts
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - app/src/lib/alert-config.ts
  - app/src/lib/alert-evaluator.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "POST /api/settings/alerts returns 200 and saves config to data/config/alerts.json"
    - "Alert evaluation reads correct data files from project root"
  artifacts:
    - path: "app/src/lib/alert-config.ts"
      provides: "Alert config read/write with correct path"
      contains: '".."'
    - path: "app/src/lib/alert-evaluator.ts"
      provides: "Alert evaluation with correct data paths"
      contains: '".."'
  key_links:
    - from: "app/src/lib/alert-config.ts"
      to: "data/config/alerts.json"
      via: "path.join with '..' to escape /app"
      pattern: 'path\.join\(process\.cwd\(\),\s*"\.\."'
    - from: "app/src/lib/alert-evaluator.ts"
      to: "data/analytics.json"
      via: "path.join with '..' to escape /app"
      pattern: 'path\.join\(process\.cwd\(\),\s*"\.\."'
---

<objective>
Fix path resolution bug in alert-config.ts and alert-evaluator.ts that causes POST /api/settings/alerts to return 500.

Purpose: Next.js cwd is /app but data lives at project root. These two files are missing ".." in their path.join() calls, unlike data.ts which already has the correct pattern.
Output: Settings save works, unblocking 6 skipped UAT tests.
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/src/lib/data.ts (reference pattern: line 24 uses "..")
@app/src/lib/alert-config.ts
@app/src/lib/alert-evaluator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix path resolution in alert-config.ts and alert-evaluator.ts</name>
  <files>app/src/lib/alert-config.ts, app/src/lib/alert-evaluator.ts</files>
  <action>
In alert-config.ts line 7, change:
```
const CONFIG_PATH = path.join(process.cwd(), "data", "config", "alerts.json");
```
to:
```
const CONFIG_PATH = path.join(process.cwd(), "..", "data", "config", "alerts.json");
```

In alert-evaluator.ts lines 12-14, add ".." to all three paths:
```
const ANALYTICS_PATH = path.join(process.cwd(), "..", "data", "analytics.json");
const TOKENS_PATH = path.join(process.cwd(), "..", "data", "tokens.json");
const STATE_PATH = path.join(process.cwd(), "..", "data", "alert-state.json");
```

This aligns with the pattern in data.ts line 24: `path.join(process.cwd(), "..", "data")`.
  </action>
  <verify>
1. `cd /home/tomas/Escritorio/AIAIAI_Consulting/app && npx next build` completes without errors
2. Start dev server, run: `curl -X POST http://localhost:3000/api/settings/alerts -H "Content-Type: application/json" -d '{"globalBudget":200,"globalThresholds":[{"percent":75,"label":"Warning"},{"percent":90,"label":"Critical"}],"perProjectLimits":{},"notificationsEnabled":true,"monthlyResetDay":1}' ` â€” returns 200
3. Confirm file exists: `cat /home/tomas/Escritorio/AIAIAI_Consulting/data/config/alerts.json`
  </verify>
  <done>POST /api/settings/alerts returns 200 and persists config to data/config/alerts.json. All path.join calls in alert-config.ts and alert-evaluator.ts include ".." to navigate from /app to project root.</done>
</task>

</tasks>

<verification>
- `grep -n '".."' app/src/lib/alert-config.ts` shows ".." in CONFIG_PATH
- `grep -n '".."' app/src/lib/alert-evaluator.ts` shows ".." in all three path constants
- Settings page save no longer returns 500
</verification>

<success_criteria>
- POST /api/settings/alerts returns 200 (was 500)
- Config persisted to data/config/alerts.json
- Path pattern matches data.ts convention
</success_criteria>

<output>
After completion, create `.planning/phases/08-budget-alerts/08-03-SUMMARY.md`
</output>
