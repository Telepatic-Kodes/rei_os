---
phase: 08-budget-alerts
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - scripts/cron-sync.ts
  - scripts/desktop-notifier.ts
  - app/src/components/alert-banner.tsx
  - app/src/app/settings/page.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Desktop notifications fire from cron process when thresholds are breached, even if browser is closed"
    - "Browser Notification API alerts appear when dashboard tab is open and a threshold is crossed"
    - "Desktop notifications fire once per threshold per month (same fire-once pattern as banners)"
  artifacts:
    - path: "scripts/desktop-notifier.ts"
      provides: "Cross-platform desktop notification helper"
      exports: ["sendDesktopNotification"]
    - path: "scripts/cron-sync.ts"
      provides: "Cron process with alert evaluation and desktop notifications after sync"
      contains: "evaluateAlerts"
  key_links:
    - from: "scripts/cron-sync.ts"
      to: "app/src/lib/alert-evaluator.ts"
      via: "evaluateAlerts() import"
      pattern: "evaluateAlerts"
    - from: "scripts/cron-sync.ts"
      to: "scripts/desktop-notifier.ts"
      via: "sendDesktopNotification() call"
      pattern: "sendDesktopNotification"
    - from: "app/src/components/alert-banner.tsx"
      to: "Notification API"
      via: "new Notification() on alert detection"
      pattern: "new Notification"
---

<objective>
Add desktop notifications (node-notifier) from the cron process and browser Notification API alerts from the client when thresholds are crossed.

Purpose: Users are warned about budget overruns even when not looking at the dashboard (desktop notifications from cron) and get immediate in-browser alerts when the tab is open.

Output: node-notifier integration in cron-sync.ts, desktop-notifier.ts helper, browser notification firing in alert-banner.tsx.
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-budget-alerts/08-01-SUMMARY.md
@scripts/cron-sync.ts
@app/src/lib/alert-evaluator.ts
@app/src/components/alert-banner.tsx
@app/src/app/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install node-notifier and create desktop notification helper</name>
  <files>
    package.json
    scripts/desktop-notifier.ts
    scripts/cron-sync.ts
  </files>
  <action>
1. Install node-notifier at root level (where scripts/ lives):
   `npm install node-notifier@^11.0.0`
   `npm install -D @types/node-notifier`

2. Create scripts/desktop-notifier.ts:
   - Import notifier from "node-notifier".
   - sendDesktopNotification(alert: { level: string, message: string, type: string }): void
   - Use notifier.notify() with:
     - title: level === "critical" ? "Critical Budget Alert" : "Budget Warning"
     - message: alert.message
     - sound: true
     - wait: false
     - timeout: 10
   - Wrap in try/catch, log errors but never throw (desktop notifications are best-effort, must not crash sync).

3. Update scripts/cron-sync.ts:
   - After runAllSyncs() completes successfully, import and call evaluateAlerts() from "../app/src/lib/alert-evaluator".
   - For each returned alert, call sendDesktopNotification(alert) from "./desktop-notifier".
   - Log each alert: `console.log("[ALERT]", alert.level, alert.message)`.
   - Wrap alert evaluation in try/catch — alert failures must not crash the cron process.
   - Import at top of file (static imports).
  </action>
  <verify>
    - `npx tsx scripts/desktop-notifier.ts` does not crash (can test with a mock call)
    - `npx tsx -e "import { sendDesktopNotification } from './scripts/desktop-notifier'; sendDesktopNotification({level:'warning',message:'Test alert',type:'global'})"` runs without error
    - scripts/cron-sync.ts has evaluateAlerts + sendDesktopNotification calls after sync
  </verify>
  <done>Desktop notifications fire from cron process when alert thresholds are breached. Failures are logged but never crash the sync process.</done>
</task>

<task type="auto">
  <name>Task 2: Browser Notification API integration in alert banner</name>
  <files>
    app/src/components/alert-banner.tsx
    app/src/app/settings/page.tsx
  </files>
  <action>
1. Update app/src/components/alert-banner.tsx:
   - After fetching alerts from /api/alert-status, if there are active alerts AND Notification.permission === "granted" AND document is not hidden:
     - For each new alert (not previously notified in this session — track with a ref or state of notifiedKeys[]):
       - Fire `new Notification(title, { body: alert.message, icon: "/favicon.ico", tag: alert.alertKey })`.
       - The `tag` property deduplicates — same tag won't show twice.
     - Add notified alertKeys to session tracking to avoid re-firing on re-fetch.
   - Add a polling interval: refetch /api/alert-status every 60 seconds (setInterval in useEffect, clear on unmount). This catches alerts generated by cron sync between page loads.
   - Guard all Notification API calls with `typeof Notification !== "undefined"` check for SSR safety.

2. Ensure app/src/app/settings/page.tsx browser notification section (from 08-01) properly:
   - Shows current Notification.permission state ("granted", "denied", "default").
   - "Enable" button only shown when permission is "default".
   - When "denied", show text: "Notifications blocked. Enable in browser settings."
   - When "granted", show green text: "Browser notifications enabled".
   - Guard with `typeof Notification !== "undefined"` for SSR.
  </action>
  <verify>
    - `cd app && npm run build` completes without errors
    - Visit /settings — browser notification section shows permission state
    - Click "Enable Browser Notifications" — browser permission prompt appears
    - When permission granted and alerts active, browser notification fires (once per alert per session)
    - Notification does not fire if permission denied or tab hidden
  </verify>
  <done>Browser Notification API fires alerts when tab is open and permission granted. Notifications deduplicated by tag. Permission flow handled in settings page with clear user guidance.</done>
</task>

</tasks>

<verification>
1. `npm install` at root succeeds, node-notifier in package.json dependencies
2. Running cron-sync manually triggers alert evaluation after sync
3. Desktop notification appears when threshold breached (on supported systems with notify-send/macOS)
4. Browser notification fires when dashboard tab is open, permission granted, and alert active
5. Same browser notification does not fire twice per session for same alert
6. Settings page shows accurate browser notification permission state
7. `cd app && npm run build` passes
8. Alert evaluation errors in cron do not crash the sync process
</verification>

<success_criteria>
- Desktop notifications fire from cron process on threshold breach (node-notifier)
- Browser Notification API fires from client when tab open + permission granted
- Both channels use fire-once-per-threshold pattern (desktop via alert-state.json, browser via session tracking)
- Cron process resilient to notification failures
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-budget-alerts/08-02-SUMMARY.md`
</output>
