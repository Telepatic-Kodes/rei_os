---
phase: 06-automated-sync
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/src/app/api/sync/route.ts
  - app/src/components/sync-button.tsx
  - app/src/components/sync-status.tsx
  - app/src/components/dashboard-header.tsx
  - app/src/components/ui/sonner.tsx
  - app/src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking the refresh button in the dashboard header triggers an immediate sync"
    - "A spinning icon and toast show sync is in progress"
    - "Toast shows success or error message when sync completes"
    - "Page reloads after successful sync to show fresh data"
    - "Dashboard header shows last sync time and success/error badge"
    - "If no sync has ever run, status shows 'Never synced'"
  artifacts:
    - path: "app/src/app/api/sync/route.ts"
      provides: "POST endpoint that calls runAllSyncs"
      exports: ["POST"]
    - path: "app/src/components/sync-button.tsx"
      provides: "Manual refresh button with loading state and toast"
      exports: ["SyncButton"]
    - path: "app/src/components/sync-status.tsx"
      provides: "Status indicator reading sync-status.json"
      exports: ["SyncStatus"]
    - path: "app/src/components/dashboard-header.tsx"
      provides: "Header bar with sync status and refresh button"
      exports: ["DashboardHeader"]
  key_links:
    - from: "app/src/components/sync-button.tsx"
      to: "app/src/app/api/sync/route.ts"
      via: "fetch POST /api/sync"
      pattern: "fetch.*api/sync.*POST"
    - from: "app/src/app/api/sync/route.ts"
      to: "app/src/lib/sync-manager.ts"
      via: "import runAllSyncs"
      pattern: "import.*runAllSyncs"
    - from: "app/src/app/layout.tsx"
      to: "sonner Toaster"
      via: "<Toaster /> in layout"
      pattern: "<Toaster"
---

<objective>
Add manual sync API route, refresh button with toast feedback, and sync status indicator in the dashboard header.

Purpose: Users can trigger sync on demand and see when data was last updated and whether it succeeded.
Output: API route, SyncButton, SyncStatus, DashboardHeader components, sonner integration.
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-automated-sync/06-RESEARCH.md
@.planning/phases/06-automated-sync/06-01-SUMMARY.md

@app/src/lib/sync-manager.ts
@app/src/lib/schemas.ts
@app/src/app/layout.tsx
@app/src/components/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: API route and sonner setup</name>
  <files>app/src/app/api/sync/route.ts, app/src/components/ui/sonner.tsx, app/src/app/layout.tsx</files>
  <action>
    Create `app/src/app/api/sync/route.ts`:
    - Export async POST handler
    - Import and call runAllSyncs() from @/lib/sync-manager
    - On success: return NextResponse.json({ success: true, message: "Sync completed successfully" })
    - On error: return NextResponse.json({ success: false, error: message }, { status: 500 })
    - If sync was skipped (already running): return NextResponse.json({ success: false, error: "Sync already in progress" }, { status: 409 })

    Add sonner to the project:
    - Run `cd app && npx shadcn@latest add sonner --yes` (this creates ui/sonner.tsx)
    - If the CLI doesn't work, manually create `app/src/components/ui/sonner.tsx` that re-exports Toaster from sonner with dark theme

    Update `app/src/app/layout.tsx`:
    - Import Toaster from @/components/ui/sonner
    - Add `<Toaster />` inside the body, after the flex div (sibling to the flex container, not inside it)
  </action>
  <verify>
    `curl -X POST http://localhost:3000/api/sync` returns JSON with success field.
    Layout.tsx contains `<Toaster />`.
  </verify>
  <done>POST /api/sync triggers full sync and returns result. Sonner Toaster is mounted in layout for toast notifications.</done>
</task>

<task type="auto">
  <name>Task 2: Dashboard header with sync button and status</name>
  <files>app/src/components/sync-button.tsx, app/src/components/sync-status.tsx, app/src/components/dashboard-header.tsx, app/src/app/layout.tsx</files>
  <action>
    Create `app/src/components/sync-status.tsx` (Server Component):
    - Read `data/sync-status.json` using readFileSync (path: join(process.cwd(), "..", "data", "sync-status.json"))
    - If file doesn't exist: render Badge with "Never synced"
    - If exists: parse with SyncStatusSchema, show Badge (green for success, red for error) + "Last sync: Xm ago" text
    - Implement formatTimeAgo helper (seconds, minutes, hours, days)
    - Use text-sm text-muted-foreground for subtle appearance

    Create `app/src/components/sync-button.tsx` ("use client"):
    - useState for syncing boolean
    - On click: set syncing=true, toast("Syncing data..."), fetch POST /api/sync
    - On success: toast.success("Sync complete"), window.location.reload()
    - On error: toast.error with error message from response
    - Finally: setSyncing(false)
    - Render: Button variant="outline" size="sm" with RefreshCw icon (animate-spin when syncing), disabled when syncing
    - Text: "Refresh" label next to icon

    Create `app/src/components/dashboard-header.tsx`:
    - Flex container with justify-between, items-center, border-b, pb-4, mb-6
    - Left: empty or slot for page title (via children or just leave empty)
    - Right: flex gap-3 with SyncStatus and SyncButton

    Update `app/src/app/layout.tsx`:
    - Import DashboardHeader
    - Add DashboardHeader inside `<main>` before `{children}`
    - The header should be inside the main content area (not in sidebar)
  </action>
  <verify>
    `npm run build` succeeds (no type errors).
    Visit localhost:3000 -- header visible with sync status and refresh button.
    Click refresh button -- spinning icon, toast appears, page reloads after sync.
  </verify>
  <done>
    Dashboard header displays sync status (last time + success/error badge) and refresh button.
    Clicking refresh triggers sync with visual feedback (spinning icon, toast) and page reload on success.
    "Never synced" shown when no sync has run yet.
  </done>
</task>

</tasks>

<verification>
1. `curl -X POST http://localhost:3000/api/sync` returns `{"success":true}` and writes sync-status.json
2. Dashboard header visible on all pages with sync status and refresh button
3. Clicking refresh shows spinning icon + "Syncing data..." toast
4. After sync completes: "Sync complete" toast, page reloads
5. Sync status updates to show new timestamp
6. When sync-status.json doesn't exist: shows "Never synced" badge
</verification>

<success_criteria>
- Manual refresh button triggers immediate sync with visual feedback
- Dashboard displays last sync time and success/error state
- Toast notifications show sync progress and result
- Page reloads after successful manual sync to show fresh data
</success_criteria>

<output>
After completion, create `.planning/phases/06-automated-sync/06-02-SUMMARY.md`
</output>
