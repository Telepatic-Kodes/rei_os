---
phase: 06-automated-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/lib/sync-manager.ts
  - scripts/cron-sync.ts
  - data/config/sync.json
  - app/package.json
autonomous: true

must_haves:
  truths:
    - "Running `npm run cron` starts a cron scheduler that triggers sync every N minutes"
    - "Sync runs all three scripts (tokens, quality, projects) sequentially"
    - "Concurrent sync attempts are skipped via lock file"
    - "Sync status (success/error, timestamp, duration) is written to data/sync-status.json"
    - "Stale lock files older than 1 hour are automatically removed"
    - "SIGTERM/SIGINT gracefully stops the cron process"
  artifacts:
    - path: "app/src/lib/sync-manager.ts"
      provides: "runAllSyncs() orchestrator with lock file and status persistence"
      exports: ["runAllSyncs"]
    - path: "scripts/cron-sync.ts"
      provides: "Standalone cron process using croner"
    - path: "data/config/sync.json"
      provides: "Configurable sync interval"
      contains: "intervalMinutes"
  key_links:
    - from: "scripts/cron-sync.ts"
      to: "app/src/lib/sync-manager.ts"
      via: "import runAllSyncs"
      pattern: "import.*runAllSyncs.*sync-manager"
    - from: "app/src/lib/sync-manager.ts"
      to: "scripts/sync-tokens.ts"
      via: "child_process exec"
      pattern: "execAsync.*sync-tokens"
---

<objective>
Create the SyncManager orchestrator and standalone cron process that automatically runs all sync scripts on a configurable interval.

Purpose: Eliminates manual script execution -- dashboard data stays current without user action.
Output: sync-manager.ts (shared orchestrator), cron-sync.ts (standalone cron), sync.json config, updated package.json scripts.
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-automated-sync/06-RESEARCH.md

@app/src/lib/atomic-write.ts
@app/src/lib/schemas.ts
@app/package.json
@scripts/sync-tokens.ts
@scripts/sync-quality.ts
@scripts/sync-projects.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create sync config</name>
  <files>app/package.json, data/config/sync.json</files>
  <action>
    Install croner and concurrently:
    ```
    cd app && npm install croner sonner && npm install --save-dev concurrently
    ```
    Note: Install sonner now too (needed in Plan 02) to avoid a second install step.

    Create `data/config/sync.json` with default config:
    ```json
    {
      "intervalMinutes": 15
    }
    ```
    This file should be tracked in git (not gitignored).

    Update `app/package.json` scripts:
    - Add `"cron": "tsx ../scripts/cron-sync.ts"`
    - Change `"dev"` to: `"concurrently \"next dev\" \"npm run cron\""`
    - Keep a `"dev:next": "next dev"` for running Next.js alone
    - Ensure existing sync-tokens, sync-quality, sync-projects scripts exist (add if missing):
      `"sync-tokens": "tsx ../scripts/sync-tokens.ts"`
      `"sync-quality": "tsx ../scripts/sync-quality.ts"`
      `"sync-projects": "tsx ../scripts/sync-projects.ts"`
  </action>
  <verify>
    `cd app && npm ls croner sonner concurrently` shows all three installed.
    `cat data/config/sync.json` shows valid JSON with intervalMinutes.
    `cat app/package.json | grep cron` shows the cron script.
  </verify>
  <done>croner, sonner, concurrently installed. sync.json config exists. package.json has cron and dev scripts.</done>
</task>

<task type="auto">
  <name>Task 2: Create SyncManager and cron-sync process</name>
  <files>app/src/lib/sync-manager.ts, scripts/cron-sync.ts</files>
  <action>
    Create `app/src/lib/sync-manager.ts`:
    - Export `async function runAllSyncs(): Promise<{status: "success" | "error" | "skipped"; durationMs?: number; error?: string}>`
    - Lock file at `data/.sync-lock` -- if exists AND younger than 1 hour, return `{status: "skipped"}`. If older than 1 hour, warn and remove (stale lock).
    - Write lock file with current ISO timestamp
    - In try block: run each sync script sequentially using `child_process.execSync` or promisified exec:
      - `tsx ../scripts/sync-tokens.ts` (cwd = app directory)
      - `tsx ../scripts/sync-quality.ts`
      - `tsx ../scripts/sync-projects.ts`
      Note: Use `npx tsx` to ensure tsx is found. Run from the `app/` directory with cwd set appropriately OR from root with correct paths. Check how existing scripts resolve paths (they use `resolve(__dirname, "..")` for ROOT).
      Simplest approach: use `execSync("npx tsx scripts/sync-tokens.ts", { cwd: ROOT })` where ROOT is the monorepo root (one level above app/).
    - On success: write `data/sync-status.json` via atomicWriteJson with `{lastSync, status: "success", durationMs}`
    - On error: write `data/sync-status.json` with `{lastSync, status: "error", error: message}`
    - In finally: remove lock file
    - Add `data/sync-status.json` and `data/.sync-lock` to `.gitignore` if not already there

    Create `scripts/cron-sync.ts`:
    - Import Cron from "croner"
    - Read `data/config/sync.json` for intervalMinutes (default 15 on read failure)
    - Create cron job with pattern `*/${intervalMinutes} * * * *`
    - Job callback: call runAllSyncs(), log result
    - Add SIGTERM/SIGINT handlers that call job.stop() then process.exit(0)
    - Log startup message with interval and next run time

    Add Zod schemas to `app/src/lib/schemas.ts`:
    - SyncConfigSchema: `{ intervalMinutes: z.number().min(1).max(1440) }`
    - SyncStatusSchema: `{ lastSync: z.string(), status: z.enum(["success", "error"]), durationMs: z.number().optional(), error: z.string().optional() }`
  </action>
  <verify>
    `cd /home/tomas/Escritorio/AIAIAI_Consulting/app && npx tsx ../scripts/cron-sync.ts` starts without errors and logs "Cron scheduler started". Kill with Ctrl+C and verify graceful shutdown message.
    `cat data/sync-status.json` after a manual trigger shows status JSON (may need to wait for first cron tick, or test sync-manager directly).
  </verify>
  <done>
    SyncManager runs all 3 sync scripts sequentially with lock file protection and status persistence.
    Cron process starts, schedules syncs, and shuts down gracefully on SIGTERM/SIGINT.
    `npm run dev` starts both Next.js and cron together via concurrently.
  </done>
</task>

</tasks>

<verification>
1. `cd app && npm run cron` starts cron and logs interval + next run time
2. Lock file prevents concurrent execution (create manual lock, run sync, see "skipped")
3. `data/sync-status.json` is written after sync completes
4. Ctrl+C gracefully stops cron process
5. `npm run dev` starts both Next.js dev server and cron process
</verification>

<success_criteria>
- Background cron process runs all sync scripts automatically on configurable interval
- Lock file prevents concurrent sync execution with 1-hour stale detection
- Sync status persisted to data/sync-status.json after each run
- `npm run dev` starts both Next.js and cron via concurrently
</success_criteria>

<output>
After completion, create `.planning/phases/06-automated-sync/06-01-SUMMARY.md`
</output>
